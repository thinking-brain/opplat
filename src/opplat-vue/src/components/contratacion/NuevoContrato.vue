<template>
  <v-container grid-list-xl fluid>
    <v-layout row wrap>
      <v-flex lg12>
        <h3>{{ formTitle }}</h3>
        <v-form ref="form">
          <v-container grid-list-md text-xs-center>
            <v-layout row wrap>
              <v-flex cols="2" md8 class="px-1">
                <v-text-field v-model="contrato.nombre" label="Nombre" clearable required></v-text-field>
              </v-flex>
              <v-flex cols="2" class="px-1" md3 v-if="!suplemento">
                <v-autocomplete
                  v-model="tipo"
                  item-text="nombre"
                  item-value="id"
                  :items="tipos"
                  cache-items
                  label="Tipo"
                ></v-autocomplete>
              </v-flex>
              <v-spacer></v-spacer>
              <v-flex cols="2" class="px-1" md3 v-if="suplemento">
                <v-autocomplete
                  v-model="tipo"
                  item-text="nombre"
                  item-value="id"
                  :items="tipos"
                  cache-items
                  label="Tipo"
                  readonly
                ></v-autocomplete>
              </v-flex>
              <v-flex cols="2" class="px-1 pt-4" md v-if="suplemento">
                <v-autocomplete
                  v-model="contratoId"
                  item-text="nombre"
                  item-value="id"
                  :items="contratos"
                  cache-items
                  label="Contrato al que pertenece"
                  readonly
                ></v-autocomplete>
              </v-flex>
              <v-flex cols="2" class="px-1 pt-1" md7 v-if="suplemento">
                <v-textarea
                  v-model="contrato.motivoSuplemento"
                  label="Motivo del Suplemento "
                  rows="1"
                ></v-textarea>
              </v-flex>
            </v-layout>
            <v-layout row wrap>
              <v-flex cols="2" class="px-1">
                <v-autocomplete
                  v-model="contrato.adminContrato"
                  item-text="administrador.nombreCompleto"
                  item-value="administrador.id"
                  :items="adminContratos"
                  cache-items
                  label="Administrador"
                >
                  <v-icon @click="dialog4=true" slot="append" color="blue darken-2">mdi-plus</v-icon>
                </v-autocomplete>
              </v-flex>
              <v-flex cols="2" class="px-1">
                <v-autocomplete
                  v-model="entidad"
                  item-text="nombre"
                  item-value="id"
                  :items="entidades"
                  cache-items
                  label="Proveedor"
                >
                  <v-icon @click="dialog3=true" slot="append" color="blue darken-2">mdi-plus</v-icon>
                </v-autocomplete>
              </v-flex>
              <v-flex cols="2" class="px-1">
                <v-autocomplete
                  v-model="contrato.departamentos"
                  item-text="nombre"
                  item-value="id"
                  :items="departamentos"
                  cache-items
                  label="Departamentos que van a Dictaminar la oferta"
                  multiple
                >
                  <template v-slot:selection="data">
                    <v-chip
                      v-bind="data.attrs"
                      :input-value="data.selected"
                      close
                      @click="data.select"
                      @click:close="removeDictaminadores(data.item)"
                      outlined
                    >{{ data.item.nombre }}</v-chip>
                  </template>
                  <template v-slot:item="data">
                    <template v-if="typeof data.item !== 'object'">
                      <v-list-item-content v-text="data.item"></v-list-item-content>
                    </template>
                    <template v-else>
                      <v-list-item-content>
                        <v-list-item-title v-html="data.item.nombre"></v-list-item-title>
                      </v-list-item-content>
                    </template>
                  </template>
                  <v-icon @click="dialog6=true" slot="append" color="blue darken-2">mdi-plus</v-icon>
                </v-autocomplete>
              </v-flex>
            </v-layout>
            <v-layout row wrap>
              <v-flex cols="2" class="px-1">
                <v-autocomplete
                  v-model="contrato.especialistasExternos"
                  item-text="nombreAMostrar"
                  item-value="id"
                  :items="especialistasExternosAll"
                  cache-items
                  label="Especialistas Externos"
                  placeholder="Dictaminadores Externos"
                  multiple
                >
                  <v-icon @click="dialog5=true" slot="append" color="blue darken-2">mdi-plus</v-icon>
                </v-autocomplete>
              </v-flex>
            </v-layout>
            <v-layout row wrap>
              <v-flex cols="2" md3 class="px-1">
                <v-text-field
                  v-model="montoAndMoneda.cantidad"
                  label="Monto"
                  :error-messages="messagesCantidad"
                  clearable
                  prefix="$"
                ></v-text-field>
              </v-flex>
              <v-flex cols="2" md1 class="px-1">
                <v-select
                  v-model="montoAndMoneda.moneda"
                  item-text="nombre"
                  item-value="id"
                  :items="monedas"
                  :error-messages="messagesMoneda"
                  label="Moneda"
                ></v-select>
              </v-flex>
              <v-flex cols="2" md1 class="pt-7">
                <v-tooltip top color="success">
                  <template v-slot:activator="{ on }">
                    <v-icon medium v-on="on" @click="agregar()" color="success">mdi-plus</v-icon>
                  </template>
                  <span>Agregar</span>
                </v-tooltip>
              </v-flex>
              <v-flex cols="2" class="px-1">
                <v-chip-group multiple column active-class="primary--text">
                  <v-chip
                    v-for="item in montos"
                    :key="item.id"
                    outlined
                    close
                    @click:close="quitar(item)"
                  >
                    <v-icon left>mdi-cash-multiple</v-icon>
                    {{ item.cantidad }}
                    {{ item.nombreString }}
                  </v-chip>
                </v-chip-group>
              </v-flex>
            </v-layout>
            <p>{{textFormaPago}}</p>
            <v-layout row wrap>
              <v-flex cols="2" md="9" class="px-1">
                <v-autocomplete
                  v-model="contrato.formasDePago"
                  :items="formasDePagos"
                  label="Formas de Pago"
                  item-text="nombre"
                  item-value="id"
                  multiple
                >
                  <template v-slot:selection="data">
                    <v-chip
                      v-bind="data.attrs"
                      :input-value="data.selected"
                      close
                      @click="data.select"
                      @click:close="removeformasDePago(data.item)"
                      outlined
                    >{{ data.item.nombre }}</v-chip>
                  </template>
                  <template v-slot:item="data">
                    <template v-if="typeof data.item !== 'object'">
                      <v-list-item-content v-text="data.item"></v-list-item-content>
                    </template>
                    <template v-else>
                      <v-list-item-content>
                        <v-list-item-title v-html="data.item.nombre"></v-list-item-title>
                      </v-list-item-content>
                    </template>
                  </template>
                </v-autocomplete>
              </v-flex>
              <v-flex cols="2">
                <v-text-field
                  v-model="contrato.terminoDePago"
                  label="Término de pago"
                  placeholder="en días áviles después de presentada la factura"
                  clearable
                  required
                ></v-text-field>
              </v-flex>
            </v-layout>
            <v-layout row wrap>
              <v-flex cols="2" class="px-1">
                <v-textarea
                  v-model="contrato.objetoDeContrato"
                  label="Objeto del Contrato"
                  rows="1"
                ></v-textarea>
              </v-flex>
            </v-layout>
            <v-layout row wrap>
              <v-flex cols="2" class="px-1">
                <v-menu
                  v-model="menu"
                  :close-on-content-click="false"
                  :nudge-right="40"
                  transition="scale-transition"
                  offset-y
                  min-width="290px"
                >
                  <template v-slot:activator="{ on }">
                    <v-text-field
                      v-model="contrato.fechaDeRecepcion"
                      label="Fecha de Recepción"
                      readonly
                      clearable
                      v-on="on"
                      required
                    ></v-text-field>
                  </template>
                  <v-date-picker v-model="contrato.fechaDeRecepcion" @input="menu = false"></v-date-picker>
                </v-menu>
              </v-flex>
              <v-flex cols="2" class="px-1">
                <v-menu
                  v-model="menu1"
                  :close-on-content-click="false"
                  :nudge-right="40"
                  transition="scale-transition"
                  offset-y
                  min-width="290px"
                >
                  <template v-slot:activator="{ on }">
                    <v-text-field
                      v-model="contrato.fechaDeVenOferta"
                      label="Fecha de Vencimiento"
                      readonly
                      clearable
                      v-on="on"
                      required
                    ></v-text-field>
                  </template>
                  <v-date-picker v-model="contrato.fechaDeVenOferta" @input="menu1 = false"></v-date-picker>
                </v-menu>
              </v-flex>
              <!-- <v-flex cols="2" class="px-1">
                    <v-file-input v-model="contrato.file" show-size label="Seleccionar Documento"></v-file-input>
              </v-flex>-->
              <!-- <v-flex cols="2" class="px-1">
                <v-autocomplete
                  v-model="contrato.estado"
                  item-text="nombre"
                  item-value="id"
                  :items="estados"
                  cache-items
                  label="EstadoOrden"
                ></v-autocomplete>
              </v-flex>-->
            </v-layout>
          </v-container>
        </v-form>
        <v-card-actions>
          <v-spacer></v-spacer>
          <v-btn color="green darken-1" text @click="save(method)" :loading="loading">Aceptar</v-btn>
          <v-btn color="blue darken-1" text @click=" close()">Cancelar</v-btn>
        </v-card-actions>
      </v-flex>
    </v-layout>
    <!-- Agregar Entidad-->
    <v-dialog v-model="dialog3" persistent max-width="1000">
      <v-card>
        <v-toolbar dark fadeOnScroll color="blue darken-3">
          <v-spacer></v-spacer>
          <v-toolbar-items>
            <v-btn icon dark @click="closeAdd()">
              <v-icon>mdi-close</v-icon>
            </v-btn>
          </v-toolbar-items>
        </v-toolbar>
        <Entidades></Entidades>
      </v-card>
    </v-dialog>
    <!-- /Agregar Entidad-->

    <!-- Agregar AdminContrato-->
    <v-dialog v-model="dialog4" persistent max-width="1000">
      <v-card>
        <v-toolbar dark fadeOnScroll color="blue darken-3">
          <v-spacer></v-spacer>
          <v-toolbar-items>
            <v-btn icon dark @click="closeAdd()">
              <v-icon>mdi-close</v-icon>
            </v-btn>
          </v-toolbar-items>
        </v-toolbar>
        <AdminContratos></AdminContratos>
      </v-card>
    </v-dialog>
    <!-- /Agregar AdminContrato-->
    <!-- Agregar EspExternos-->
    <v-dialog v-model="dialog5" persistent max-width="1000">
      <v-card>
        <v-toolbar dark fadeOnScroll color="blue darken-3">
          <v-spacer></v-spacer>
          <v-toolbar-items>
            <v-btn icon dark @click="closeAdd()">
              <v-icon>mdi-close</v-icon>
            </v-btn>
          </v-toolbar-items>
        </v-toolbar>
        <EspExternos></EspExternos>
      </v-card>
    </v-dialog>
    <!-- /Agregar EspExternos-->
    <!-- Agregar Dictaminadores Contrato-->
    <v-dialog v-model="dialog6" persistent max-width="1000">
      <v-card>
        <v-toolbar dark fadeOnScroll color="blue darken-3">
          <v-spacer></v-spacer>
          <v-toolbar-items>
            <v-btn icon dark @click="closeAdd()">
              <v-icon>mdi-close</v-icon>
            </v-btn>
          </v-toolbar-items>
        </v-toolbar>
        <DictContratos></DictContratos>
      </v-card>
    </v-dialog>
    <!-- /Agregar Dictaminadores Contrato-->
  </v-container>
</template>
<script>
import api from "@/api";
import AdminContratos from "@/components/contratacion/AdminContratos.vue";
import EspExternos from "@/components/contratacion/EspExternos.vue";
import FormasDePago from "@/components/contratacion/FormasDePago.vue";
import Entidades from "@/components/contratacion/Entidades.vue";
import DictContratos from "@/components/contratacion/DictContratos.vue";

export default {
  props: ["contrato"],
  components: {
    AdminContratos,
    EspExternos,
    FormasDePago,
    Entidades,
    DictContratos
  },
  data: () => ({
    dialog3: false,
    dialog4: false,
    dialog5: false,
    dialog6: false,
    menu: false,
    menu1: false,
    search: "",
    editedIndex: -1,
    ofertas: [],
    cantOfertas: 0,
    file: null,
    contratos: [],
    entidades: [],
    entidad: {},
    especialistasExternosAll: [],
    dictaminadoresContratos: [],
    adminContratos: [],
    estados: [],
    tipos: [],
    tipo: {},
    formasDePagos: [],
    departamentos: [],
    monedas: [],
    trabajadores: [],
    montoAndMoneda: {
      cantidad: null,
      moneda: null,
      nombreString: null
    },
    montos: [],
    errors: [],
    roles: [],
    username: null,
    title: "",
    messagesMoneda: "",
    messagesCantidad: "",
    messagesFormaPago: "",
    disabled: true,
    MonedaRules: [v => !!v || "Faltan datos por llenar"],
    MontoRules: [v => !!v || "Faltan datos por llenar"],
    textFormaPago: "",
    loading: false,
    suplemento: false,
    contratoId: null
  }),
  computed: {
    formTitle() {
      if (this.contrato.id != null) {
        this.editedIndex = this.contrato.id;
        this.contratoId = this.contrato.contratoId;
      }
      if (this.editedIndex != -1) {
        this.entidad = this.contrato.entidad;
      }
      if (this.contrato.tipo == 12) {
        this.entidad = this.contrato.entidad.id;
        return "Suplementar Contrato: " + this.contrato.contratoPertenece;
      } else return this.editedIndex === -1 ? "Nueva Oferta" : "Editar Oferta";
    },
    method() {
      if (this.contrato.tipo == 12) {
        if (!this.contrato.edit) {
          return "POST";
        } else {
          return "PUT";
        }
      } else return this.editedIndex === -1 ? "POST" : "PUT";
    }
  },
  watch: {
    // entidad: function() {
    //   this.disabled = false;
    //   this.textFormaPago = "";
    //   this.getFormasDePagosFromApi();
    //   this.getMonedasEntidad();
    // },
    // monedas: function() {
    //   console.log(this.monedas.length);
    //   if (this.monedas.length === 0) {
    //     this.textFormaPago =
    //       "Este proveedor no tiene cuenta bancaria asociada, la única forma de pago que va a admitir es pago en efectivo";
    //     var formadepago = {
    //       id: 2,
    //       nombre: "Efectivo"
    //     };
    //     this.formasDePagos = [];
    //     this.formasDePagos.push(formadepago);
    //     this.getMonedasFromApi();
    //   }
    // },
    tipo: function() {
      if (this.tipo == 12) {
        this.suplemento = true;
      } else {
        this.suplemento = false;
      }
    },
    contratoId: function() {
      this.contrato.contratoId = this.contratoId;
    }
  },

  created() {
    this.roles = this.$store.getters.roles;
    this.username = this.$store.getters.usuario;
    this.montos = this.contrato.montos;
    this.tipo = this.contrato.tipo;
    this.contratoId = this.contrato.contratoId;
    this.getOfertasFromApi();
    this.getContratosFromApi();
    this.getEstadosFromApi();
    this.getTiposFromApi();
    this.getEntidadesFromApi();
    this.getEspecialistasExternosFromApi();
    this.getAdminContratosFromApi();
    this.getDictContratosFromApi();
    this.getFormasDePagosFromApi();
    this.getTrabajadoresFromApi();
    this.getTiempoVenOfertasFromApi();
    this.getDepartamentosFromApi();
    this.getMonedasFromApi();
  },

  methods: {
    getOfertasFromApi() {
      const url = api.getUrl(
        "contratacion",
        "Contratos?tipoTramite=contrato&cliente=true"
      );
      this.axios.get(url).then(
        response => {
          this.textByfiltro = "Ofertas de los Clientes";
          this.ofertas = response.data;
          this.cantOfertas = this.ofertas.length;
        },
        error => {
          console.log(error);
        }
      );
    },
    getContratosFromApi() {
      var username = this.$store.getters.usuario;
      var direccion = `Contratos?tipoTramite=contrato&cliente=${this.contrato.cliente}&username=${username}&roles=${this.roles}`;
      if (this.roles == "administrador") {
        direccion = `Contratos?tipoTramite=contrato&cliente=${this.contrato.cliente}`;
      }
      const url = api.getUrl("contratacion", direccion);
      this.axios.get(url).then(
        response => {
          this.contratos = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getEstadosFromApi() {
      const url = api.getUrl("contratacion", "contratos/Estados");
      this.axios.get(url).then(
        response => {
          this.estados = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getTiposFromApi() {
      const url = api.getUrl("contratacion", "contratos/Tipos");
      this.axios.get(url).then(
        response => {
          this.tipos = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getEntidadesFromApi() {
      const url = api.getUrl("contratacion", "Entidades");
      this.axios.get(url).then(
        response => {
          this.entidades = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getEspecialistasExternosFromApi() {
      const url = api.getUrl("contratacion", "EspecialistasExternos");
      this.axios.get(url).then(
        response => {
          this.especialistasExternosAll = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getFormasDePagosFromApi() {
      const url = api.getUrl("contratacion", "FormasDePagos");
      this.axios.get(url).then(
        response => {
          this.formasDePagos = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getAdminContratosFromApi() {
      const url = api.getUrl("contratacion", "AdminContratos");
      this.axios.get(url).then(
        response => {
          this.adminContratos = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getDictContratosFromApi() {
      const url = api.getUrl("contratacion", "DictContratos");
      this.axios.get(url).then(
        response => {
          this.dictaminadoresContratos = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getTrabajadoresFromApi() {
      const url = api.getUrl("recursos_humanos", "Trabajadores");
      this.axios.get(url).then(
        response => {
          this.trabajadores = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getTiempoVenOfertasFromApi() {
      const url = api.getUrl("contratacion", "TiempoVenOfertas");
      this.axios.get(url).then(
        response => {
          this.tiempoVenOfertas = response.data[0];
        },
        error => {
          console.log(error);
        }
      );
    },
    getDepartamentosFromApi() {
      const url = api.getUrl("contratacion", "Departamentos/ForNewContract");
      this.axios.get(url).then(
        response => {
          this.departamentos = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    getMonedasFromApi() {
      const url = api.getUrl("contratacion", "Entidades/Monedas");
      this.axios.get(url).then(
        response => {
          this.monedas = response.data;
        },
        error => {
          console.log(error);
        }
      );
    },
    // getMonedasEntidad() {
    //   const url = api.getUrl("contratacion", "Entidades/Monedas");
    //   this.axios.get(`${url}/${this.entidad}`).then(
    //     response => {
    //       this.monedas = response.data;
    //     },
    //     error => {
    //       console.log(error);
    //     }
    //   );
    // },
    save(method) {
      const url = api.getUrl("contratacion", "Contratos");
      this.contrato.entidad = this.entidad;
      this.contrato.username = this.username;
      if (
        this.montoAndMoneda.cantidad == null &&
        this.montoAndMoneda.moneda != null
      ) {
        this.messagesCantidad = "Faltan datos por llenar";
      } else if (
        this.montoAndMoneda.moneda == null &&
        this.montoAndMoneda.cantidad != null
      ) {
        this.messagesMoneda = "Faltan datos por llenar";
      } else if (
        this.montoAndMoneda.cantidad != null &&
        this.montoAndMoneda.moneda != null
      ) {
        this.montos.push(this.montoAndMoneda);
      }
      this.contrato.montos = this.montos;
      this.contrato.tipo = this.tipo;

      if (method === "POST") {
        if (this.$refs.form.validate()) {
          this.contrato.username = this.username;
          this.loading = true;
          this.axios.post(url, this.contrato).then(
            response => {
              this.getResponse(response);
              this.loading = false;
              if (
                this.contrato.cliente == true &&
                this.contrato.esContrato == true
              ) {
                this.$router.push({
                  name: "ContratosCliente"
                });
              } else if (
                this.contrato.cliente == false &&
                this.contrato.esContrato == true
              ) {
                this.$router.push({
                  name: "ContratosPrestador"
                });
              } else if (this.contrato.cliente == true) {
                this.$router.push({
                  name: "OfertasClientes"
                });
              } else
                this.$router.push({
                  name: "OfertasPrestador"
                });
            },
            error => {
              vm.$snotify.error(error.response.data);
              console.log(error);
            }
          );
        }
      }
      if (method === "PUT") {
        this.contrato.entidad = this.entidad.id;
        this.contrato.username = this.username;
        this.contrato.montos = this.montos;
        this.contrato.tipo = this.tipo;
         this.loading = false;
        const url = api.getUrl("contratacion", "Contratos");
        this.axios
          .put(`${url}/${this.contrato.id}`, this.contrato)
          .then(
            response => {
              this.getResponse(response);
              if (this.contrato.cliente == true) {
                this.$router.push({
                  name: "OfertasClientes"
                });
              } else
                this.$router.push({
                  name: "OfertasPrestador"
                });
            },
            error => {
              console.log(error);
            }
          )
          .catch(e => {
            vm.$snotify.error(e.response.data.errors);
          });
      }
    },
    close() {
      if (this.contrato.cliente == true && this.contrato.esContrato == true) {
        this.$router.push({
          name: "ContratosCliente"
        });
      } else if (
        this.contrato.cliente == false &&
        this.contrato.esContrato == true
      )
        this.$router.push({
          name: "ContratosPrestador"
        });
      if (this.contrato.cliente == true && this.contrato.esContrato == false) {
        this.$router.push({
          name: "OfertasClientes"
        });
      } else if (
        this.contrato.cliente == false &&
        this.contrato.esContrato == false
      )
        this.$router.push({
          name: "OfertasPrestador"
        });
    },
    closeAdd() {
      this.getEntidadesFromApi();
      this.getEspecialistasExternosFromApi();
      this.getAdminContratosFromApi();
      this.getDictContratosFromApi();
      this.getDepartamentosFromApi();
      this.dialog3 = false;
      this.dialog4 = false;
      this.dialog5 = false;
      this.dialog6 = false;
    },
    getResponse(response) {
      if (response.status === 200 || response.status === 201) {
        vm.$snotify.success("Exito al realizar la operación");
      }
    },
    removeformasDePago(item) {
      const index = this.contrato.formasDePago.indexOf(item.id);
      if (index >= 0) this.contrato.formasDePago.splice(index, 1);
    },
    removeDictaminadores(item) {
      const index = this.contrato.departamentos.indexOf(item.id);
      if (index >= 0) this.contrato.departamentos.splice(index, 1);
    },
    agregar() {
      if (
        this.montoAndMoneda.cantidad != null &&
        this.montoAndMoneda.moneda != null
      ) {
        const m = this.monedas.find(x => x.id === this.montoAndMoneda.moneda);
        this.montoAndMoneda.nombreString = m.nombre;
        this.montos.push(this.montoAndMoneda);
        this.montoAndMoneda = {
          cantidad: null,
          moneda: null,
          nombreString: null
        };
        this.messagesMoneda = "";
        this.messagesCantidad = "";
      } else if (this.montoAndMoneda.cantidad == null) {
        this.messagesCantidad = "Faltan datos por llenar";
      } else if (this.montoAndMoneda.moneda == null) {
        this.messagesMoneda = "Faltan datos por llenar";
      }
    },
    quitar(item) {
      this.montos.splice(this.montos.indexOf(item), 1);
    },
    aprobarOferta(item) {}
  }
};
</script>